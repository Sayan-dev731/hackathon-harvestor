{% extends "base.html" %}

{% block title %}Edit - {{ hackathon.title }}{% endblock %}

{% block content %}
<div class="d-flex flex-items-center mb-4">
    <a href="{{ url_for('view_hackathon', hackathon_id=hackathon._id) }}" class="btn btn-sm btn-secondary mr-3">
        <i class="fas fa-arrow-left mr-1"></i>Back to Details
    </a>
    <h1 class="page-title">Edit Hackathon</h1>
</div>

<form action="{{ url_for('update_hackathon', hackathon_id=hackathon._id) }}" method="POST">
    <div class="card">
        <!-- Basic Information -->
        <div class="mb-4">
            <h3 class="mb-3">
                <i class="fas fa-info-circle mr-2"></i>Basic Information
            </h3>

            <div class="form-group mb-3">
                <label class="label" for="title">Title *</label>
                <input type="text" id="title" name="title" class="form-control" value="{{ hackathon.title }}" required>
            </div>

            <div class="form-group mb-3">
                <label class="label" for="description">Description</label>
                <textarea id="description" name="description" class="form-control"
                    rows="4">{{ hackathon.description or '' }}</textarea>
            </div>

            <div class="d-grid gap-3" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="form-group">
                    <label class="label" for="organizer">Organizer</label>
                    <input type="text" id="organizer" name="organizer" class="form-control"
                        value="{{ hackathon.organizer or '' }}">
                </div>

                <div class="form-group">
                    <label class="label" for="platform">Platform</label>
                    <select id="platform" name="platform" class="form-control">
                        <option value="">Select Platform</option>
                        <option value="unstop" {% if hackathon.platform=='unstop' %}selected{% endif %}>Unstop</option>
                        <option value="devfolio" {% if hackathon.platform=='devfolio' %}selected{% endif %}>Devfolio
                        </option>
                        <option value="hackerearth" {% if hackathon.platform=='hackerearth' %}selected{% endif %}>
                            HackerEarth</option>
                        <option value="mlh" {% if hackathon.platform=='mlh' %}selected{% endif %}>MLH</option>
                        <option value="hackathon.io" {% if hackathon.platform=='hackathon.io' %}selected{% endif %}>
                            Hackathon.io</option>
                        <option value="other" {% if hackathon.platform=='other' %}selected{% endif %}>Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="label" for="status">Status</label>
                    <select id="status" name="status" class="form-control">
                        <option value="open" {% if hackathon.status=='open' %}selected{% endif %}>Open</option>
                        <option value="closed" {% if hackathon.status=='closed' %}selected{% endif %}>Closed</option>
                        <option value="upcoming" {% if hackathon.status=='upcoming' %}selected{% endif %}>Upcoming
                        </option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Dates and Deadlines -->
        <div class="mb-4">
            <h3 class="mb-3">
                <i class="fas fa-calendar mr-2"></i>Dates & Deadlines
            </h3>

            <div class="d-grid gap-3" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="form-group">
                    <label class="label" for="registration_deadline">Registration Deadline</label>
                    <input type="date" id="registration_deadline" name="registration_deadline" class="form-control"
                        value="{{ hackathon.registration_deadline if hackathon.registration_deadline != 'TBD' else '' }}">
                </div>

                <div class="form-group">
                    <label class="label" for="event_date">Event Date</label>
                    <input type="date" id="event_date" name="event_date" class="form-control"
                        value="{{ hackathon.event_date if hackathon.event_date != 'TBD' else '' }}">
                </div>
            </div>
        </div>

        <!-- Prize and Links -->
        <div class="mb-4">
            <h3 class="mb-3">
                <i class="fas fa-trophy mr-2"></i>Prize & Links
            </h3>

            <div class="d-grid gap-3" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="form-group">
                    <label class="label" for="prize_pool">Prize Pool</label>
                    <input type="text" id="prize_pool" name="prize_pool" class="form-control"
                        value="{{ hackathon.prize_pool or '' }}" placeholder="e.g., $10,000, â‚¹50,000">
                </div>

                <div class="form-group">
                    <label class="label" for="website_url">Website URL</label>
                    <input type="url" id="website_url" name="website_url" class="form-control"
                        value="{{ hackathon.website_url or '' }}" placeholder="https://...">
                </div>
            </div>
        </div>

        <!-- Tags and Eligibility -->
        <div class="mb-4">
            <h3 class="mb-3">
                <i class="fas fa-tags mr-2"></i>Categories & Eligibility
            </h3>

            <div class="form-group mb-3">
                <label class="label" for="tags">Tags</label>
                <input type="text" id="tags" name="tags" class="form-control"
                    value="{{ hackathon.tags|join(', ') if hackathon.tags else '' }}"
                    placeholder="web development, AI/ML, blockchain, mobile app">
                <small class="text-gray">Separate tags with commas</small>
            </div>

            <div class="form-group">
                <label class="label" for="eligibility">Eligibility</label>
                <select id="eligibility" name="eligibility" class="form-control">
                    <option value="">Select Eligibility</option>
                    <option value="Students only" {% if hackathon.eligibility=='Students only' %}selected{% endif %}>
                        Students only</option>
                    <option value="Professionals only" {% if hackathon.eligibility=='Professionals only' %}selected{%
                        endif %}>Professionals only</option>
                    <option value="Open to all" {% if hackathon.eligibility=='Open to all' %}selected{% endif %}>Open to
                        all</option>
                    <option value="Students and Professionals" {% if hackathon.eligibility=='Students and Professionals'
                        %}selected{% endif %}>Students and Professionals</option>
                </select>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="border-top pt-4">
            <div class="d-flex gap-3">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save mr-1"></i>Save Changes
                </button>

                <a href="{{ url_for('view_hackathon', hackathon_id=hackathon._id) }}" class="btn btn-secondary">
                    <i class="fas fa-times mr-1"></i>Cancel
                </a>

                <button type="button" onclick="resetForm()" class="btn btn-secondary">
                    <i class="fas fa-undo mr-1"></i>Reset
                </button>

                <button type="button" onclick="deleteHackathon('{{ hackathon._id }}')" class="btn btn-danger ml-auto">
                    <i class="fas fa-trash mr-1"></i>Delete
                </button>
            </div>
        </div>
    </div>
</form>

<!-- Quick Actions -->
<div class="card mt-4">
    <h3 class="mb-3">
        <i class="fas fa-bolt mr-2"></i>Quick Actions
    </h3>

    <div class="d-flex flex-wrap gap-3">
        <button onclick="autoFillDates()" class="btn btn-sm btn-secondary">
            <i class="fas fa-calendar-plus mr-1"></i>Auto-detect Dates
        </button>

        <button onclick="validateWebsite()" class="btn btn-sm btn-secondary">
            <i class="fas fa-link mr-1"></i>Validate Website
        </button>

        <button onclick="suggestTags()" class="btn btn-sm btn-secondary">
            <i class="fas fa-lightbulb mr-1"></i>Suggest Tags
        </button>

        <button onclick="previewChanges()" class="btn btn-sm btn-secondary">
            <i class="fas fa-eye mr-1"></i>Preview Changes
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Store original form values for reset functionality
    const originalValues = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        organizer: document.getElementById('organizer').value,
        platform: document.getElementById('platform').value,
        status: document.getElementById('status').value,
        registration_deadline: document.getElementById('registration_deadline').value,
        event_date: document.getElementById('event_date').value,
        prize_pool: document.getElementById('prize_pool').value,
        website_url: document.getElementById('website_url').value,
        tags: document.getElementById('tags').value,
        eligibility: document.getElementById('eligibility').value
    };

    function resetForm() {
        if (confirm('Are you sure you want to reset all changes?')) {
            Object.keys(originalValues).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = originalValues[key];
                }
            });
        }
    }

    async function deleteHackathon(hackathonId) {
        if (!confirm('Are you sure you want to delete this hackathon? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/delete/${hackathonId}`, {
                method: 'POST'
            });

            const result = await response.json();

            if (result.success) {
                alert('Hackathon deleted successfully!');
                window.location.href = '{{ url_for("index") }}';
            } else {
                alert('Error deleting hackathon: ' + result.error);
            }
        } catch (error) {
            alert('Network error: ' + error.message);
        }
    }

    function autoFillDates() {
        const description = document.getElementById('description').value.toLowerCase();
        const title = document.getElementById('title').value.toLowerCase();
        const text = description + ' ' + title;

        // Simple date extraction patterns
        const patterns = [
            /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/g,
            /(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/g,
            /(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]* (\d{1,2})[,\s]*(\d{4})/gi
        ];

        let foundDates = [];
        patterns.forEach(pattern => {
            const matches = [...text.matchAll(pattern)];
            foundDates = foundDates.concat(matches);
        });

        if (foundDates.length > 0) {
            alert(`Found ${foundDates.length} potential date(s). Please review and update manually.`);
        } else {
            alert('No dates detected in the text. Please enter dates manually.');
        }
    }

    async function validateWebsite() {
        const url = document.getElementById('website_url').value;
        if (!url) {
            alert('Please enter a website URL first.');
            return;
        }

        try {
            // Simple URL validation
            new URL(url);

            // Try to fetch the URL (will be blocked by CORS, but we can check if it's a valid format)
            const isValid = /^https?:\/\/[^\s$.?#].[^\s]*$/i.test(url);

            if (isValid) {
                alert('URL format appears valid. Please verify manually that the link works.');
            } else {
                alert('URL format appears invalid. Please check the URL.');
            }
        } catch (e) {
            alert('Invalid URL format. Please enter a valid URL starting with http:// or https://');
        }
    }

    function suggestTags() {
        const title = document.getElementById('title').value.toLowerCase();
        const description = document.getElementById('description').value.toLowerCase();
        const text = title + ' ' + description;

        const tagSuggestions = [];

        // AI/ML keywords
        if (/ai|artificial intelligence|machine learning|ml|deep learning|neural|data science/i.test(text)) {
            tagSuggestions.push('AI/ML');
        }

        // Web development
        if (/web|frontend|backend|fullstack|react|angular|vue|javascript|html|css/i.test(text)) {
            tagSuggestions.push('Web Development');
        }

        // Mobile
        if (/mobile|android|ios|flutter|react native|app development/i.test(text)) {
            tagSuggestions.push('Mobile App');
        }

        // Blockchain
        if (/blockchain|crypto|ethereum|bitcoin|web3|defi|nft/i.test(text)) {
            tagSuggestions.push('Blockchain');
        }

        // Cloud/DevOps
        if (/cloud|aws|azure|docker|kubernetes|devops/i.test(text)) {
            tagSuggestions.push('Cloud/DevOps');
        }

        // Gaming
        if (/game|gaming|unity|unreal|gamedev/i.test(text)) {
            tagSuggestions.push('Game Development');
        }

        // IoT
        if (/iot|internet of things|sensor|arduino|raspberry pi/i.test(text)) {
            tagSuggestions.push('IoT');
        }

        if (tagSuggestions.length > 0) {
            const currentTags = document.getElementById('tags').value;
            const newTags = currentTags ? currentTags + ', ' + tagSuggestions.join(', ') : tagSuggestions.join(', ');
            document.getElementById('tags').value = newTags;
            alert(`Added suggested tags: ${tagSuggestions.join(', ')}`);
        } else {
            alert('No specific technology tags detected. Please add relevant tags manually.');
        }
    }

    function previewChanges() {
        const formData = new FormData(document.querySelector('form'));
        const changes = {};

        for (let [key, value] of formData.entries()) {
            if (originalValues[key] !== value) {
                changes[key] = {
                    old: originalValues[key] || 'Empty',
                    new: value || 'Empty'
                };
            }
        }

        if (Object.keys(changes).length === 0) {
            alert('No changes detected.');
            return;
        }

        let changeText = 'Changes to be saved:\n\n';
        Object.entries(changes).forEach(([key, values]) => {
            changeText += `${key.replace('_', ' ').toUpperCase()}:\n`;
            changeText += `  From: ${values.old}\n`;
            changeText += `  To: ${values.new}\n\n`;
        });

        alert(changeText);
    }

    // Auto-save draft functionality
    let autoSaveTimeout;
    document.querySelectorAll('input, textarea, select').forEach(element => {
        element.addEventListener('input', () => {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                // Save to localStorage as draft
                const formData = new FormData(document.querySelector('form'));
                const draft = {};
                for (let [key, value] of formData.entries()) {
                    draft[key] = value;
                }
                localStorage.setItem('hackathon_draft_{{ hackathon._id }}', JSON.stringify(draft));
            }, 2000);
        });
    });

    // Load draft on page load
    window.addEventListener('load', () => {
        const draft = localStorage.getItem('hackathon_draft_{{ hackathon._id }}');
        if (draft) {
            const draftData = JSON.parse(draft);
            let hasChanges = false;

            Object.entries(draftData).forEach(([key, value]) => {
                if (originalValues[key] !== value) {
                    hasChanges = true;
                }
            });

            if (hasChanges && confirm('Found unsaved changes. Would you like to restore them?')) {
                Object.entries(draftData).forEach(([key, value]) => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = value;
                    }
                });
            }
        }
    });

    // Clear draft on successful save
    document.querySelector('form').addEventListener('submit', () => {
        localStorage.removeItem('hackathon_draft_{{ hackathon._id }}');
    });
</script>
{% endblock %}