{% extends "base.html" %}

{% block title %}Hackathon Harvester - Top 10 Popular Hackathons{% endblock %}

{% block content %}
<div class="d-flex flex-justify-between flex-items-center mb-4">
    <div>
        <h1 class="page-title">üèÜ Top 10 Popular Hackathons</h1>
        <p class="page-description">
            Automatically updated every 6 hours with the most popular hackathons from Unstop, Devfolio, HackerEarth, and
            other platforms.
        </p>
    </div>
</div>

<!-- Auto Update Status -->
<div class="alert alert-info mb-4">
    <i class="fas fa-clock mr-2"></i>
    <strong>Auto-Update:</strong> This list is automatically refreshed every 6 hours with the latest popular hackathons.
    <br>
    <small>Last updated: {% if hackathons and hackathons[0].scraped_at %}{{ hackathons[0].scraped_at.strftime('%Y-%m-%d
        %H:%M UTC') }}{% else %}Not available{% endif %}</small>
</div>

<!-- Manual Refresh Section -->
<div class="scrape-section">
    <h3 class="mb-3">ÔøΩ Manual Refresh</h3>
    <p class="text-gray mb-3">Click below to manually refresh the hackathon list.</p>

    <div class="d-flex flex-column flex-md-row gap-3">
        <input type="text" id="search-query" class="form-control flex-1" placeholder="Search for popular hackathons"
            value="popular latest hackathons 2024 2025 unstop devfolio">
        <button id="scrape-btn" class="btn btn-primary">
            <i class="fas fa-sync-alt mr-1"></i>
            Refresh Hackathons
        </button>
    </div>

    <div id="scrape-status" class="mt-3" style="display: none;"></div>
</div>

<!-- Stats Section -->
<div class="d-flex flex-wrap gap-4 mb-4">
    <div class="d-flex flex-items-center">
        <i class="fas fa-trophy text-yellow mr-2"></i>
        <span class="text-bold">{{ hackathons|length }}</span>
        <span class="text-gray ml-1">Popular Hackathons</span>
    </div>
    <div class="d-flex flex-items-center">
        <i class="fas fa-clock text-blue mr-2"></i>
        <span class="text-bold">{{ hackathons|selectattr("status", "equalto", "open")|list|length }}</span>
        <span class="text-gray ml-1">Open for Registration</span>
    </div>
    <div class="d-flex flex-items-center">
        <i class="fas fa-calendar text-green mr-2"></i>
        <span class="text-bold">{{ hackathons|selectattr("status", "equalto", "upcoming")|list|length }}</span>
        <span class="text-gray ml-1">Upcoming</span>
    </div>
</div>

<!-- Simplified Hackathons List -->
{% if hackathons %}
<div class="hackathon-list">
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th style="width: 50%;">Hackathon Name</th>
                    <th style="width: 20%;">End Date</th>
                    <th style="width: 15%;">Platform</th>
                    <th style="width: 15%;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for hackathon in hackathons %}
                <tr>
                    <td>
                        <div class="d-flex flex-items-center">
                            <i class="fas fa-trophy text-yellow mr-2"></i>
                            <div>
                                <strong>{{ hackathon.title }}</strong>
                                {% if hackathon.status %}
                                <br>
                                <span class="status-badge status-{{ hackathon.status }}">
                                    {{ hackathon.status|title }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td>
                        {% if hackathon.end_date %}
                        <div class="d-flex flex-items-center">
                            <i class="fas fa-calendar-alt text-blue mr-1"></i>
                            <span>{{ hackathon.end_date }}</span>
                        </div>
                        {% else %}
                        <span class="text-gray">TBD</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if hackathon.platform %}
                        <span class="platform-badge">{{ hackathon.platform|title }}</span>
                        {% else %}
                        <span class="text-gray">Unknown</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if hackathon.website_url %}
                        <a href="{{ hackathon.website_url }}" target="_blank" class="btn btn-sm btn-primary">
                            <i class="fas fa-external-link-alt mr-1"></i>Apply
                        </a>
                        {% else %}
                        <span class="text-gray">No link</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="empty-state">
    <i class="fas fa-search fa-3x mb-3" style="color: var(--color-fg-muted);"></i>
    <h3>No hackathons found</h3>
    <p>The system is currently fetching popular hackathons. Please wait or refresh manually.</p>
    <button onclick="document.getElementById('scrape-btn').click()" class="btn btn-primary mt-3">
        <i class="fas fa-sync-alt mr-1"></i>Refresh Now
    </button>
</div>
{% endif %}

{% if error %}
<div class="flash flash-error">
    <i class="fas fa-exclamation-circle mr-2"></i>
    {{ error }}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('scrape-btn').addEventListener('click', async function () {
        const btn = this;
        const statusDiv = document.getElementById('scrape-status');
        const query = document.getElementById('search-query').value.trim();

        if (!query) {
            alert('Please enter a search query');
            return;
        }

        // Update UI
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Refreshing...';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<div class="alert alert-warning"><i class="fas fa-info-circle mr-2"></i>Finding the top 10 most popular hackathons. This may take a moment...</div>';

        try {
            const response = await fetch('/scrape', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: query })
            });

            const result = await response.json();

            if (result.success) {
                statusDiv.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle mr-2"></i>Successfully found ${result.count} popular hackathons! Refreshing page...</div>`;
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                statusDiv.innerHTML = `<div class="alert alert-error"><i class="fas fa-exclamation-circle mr-2"></i>Error: ${result.error}</div>`;
            }
        } catch (error) {
            statusDiv.innerHTML = `<div class="alert alert-error"><i class="fas fa-exclamation-circle mr-2"></i>Network error: ${error.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sync-alt mr-1"></i>Refresh Hackathons';
        }
    });

    // Auto-refresh page every 30 minutes to show updated data
    setInterval(() => {
        // Only refresh if no input is focused
        if (!document.activeElement || document.activeElement.tagName === 'BODY') {
            window.location.reload();
        }
    }, 1800000); // 30 minutes

    // Show next auto-update countdown
    function updateCountdown() {
        const lastUpdate = new Date('{% if hackathons and hackathons[0].scraped_at %}{{ hackathons[0].scraped_at.isoformat() }}{% endif %}');
        const nextUpdate = new Date(lastUpdate.getTime() + (6 * 60 * 60 * 1000)); // 6 hours later
        const now = new Date();
        const timeUntilUpdate = nextUpdate - now;

        if (timeUntilUpdate > 0) {
            const hours = Math.floor(timeUntilUpdate / (1000 * 60 * 60));
            const minutes = Math.floor((timeUntilUpdate % (1000 * 60 * 60)) / (1000 * 60));
            document.title = `(${hours}h ${minutes}m) Top 10 Popular Hackathons`;
        }
    }

    // Update countdown every minute
    if ('{% if hackathons and hackathons[0].scraped_at %}true{% endif %}') {
        updateCountdown();
        setInterval(updateCountdown, 60000);
    }
</script>
{% endblock %}