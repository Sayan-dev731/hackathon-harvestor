{% extends "base.html" %}

{% block title %}{{ hackathon.title }} - Hackathon Details{% endblock %}

{% block content %}
<div class="d-flex flex-items-center mb-3">
    <a href="{{ url_for('index') }}" class="btn btn-sm btn-secondary mr-3">
        <i class="fas fa-arrow-left mr-1"></i>Back to Home
    </a>
    <div class="d-flex flex-items-center gap-2">
        <a href="{{ url_for('edit_hackathon', hackathon_id=hackathon._id) }}" class="btn btn-sm btn-primary">
            <i class="fas fa-edit mr-1"></i>Edit
        </a>
        <button onclick="deleteHackathon('{{ hackathon._id }}')" class="btn btn-sm btn-danger">
            <i class="fas fa-trash mr-1"></i>Delete
        </button>
    </div>
</div>

<div class="card">
    <!-- Header -->
    <div class="d-flex flex-justify-between flex-items-start mb-4">
        <div class="flex-1">
            <h1 class="page-title mb-2">{{ hackathon.title }}</h1>
            <div class="d-flex flex-items-center gap-3 mb-3">
                <span class="status-badge status-{{ hackathon.status }}">
                    {{ hackathon.status }}
                </span>
                {% if hackathon.platform %}
                <span class="d-flex flex-items-center text-gray">
                    <i class="fas fa-globe mr-1"></i>{{ hackathon.platform|title }}
                </span>
                {% endif %}
            </div>
        </div>
        {% if hackathon.website_url %}
        <a href="{{ hackathon.website_url }}" target="_blank" class="btn btn-primary">
            <i class="fas fa-external-link-alt mr-1"></i>Apply Now
        </a>
        {% endif %}
    </div>

    <!-- Key Information Grid -->
    <div class="d-grid gap-4 mb-4" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
        <!-- Organizer -->
        <div class="p-3 border rounded-2">
            <div class="d-flex flex-items-center mb-2">
                <i class="fas fa-building text-blue mr-2"></i>
                <span class="text-bold">Organizer</span>
            </div>
            <div class="text-gray">{{ hackathon.organizer or 'Not specified' }}</div>
        </div>

        <!-- Registration Deadline -->
        <div class="p-3 border rounded-2">
            <div class="d-flex flex-items-center mb-2">
                <i class="fas fa-calendar-times text-red mr-2"></i>
                <span class="text-bold">Registration Deadline</span>
            </div>
            <div class="text-gray">{{ hackathon.registration_deadline or 'TBD' }}</div>
        </div>

        <!-- Event Date -->
        <div class="p-3 border rounded-2">
            <div class="d-flex flex-items-center mb-2">
                <i class="fas fa-calendar text-green mr-2"></i>
                <span class="text-bold">Event Date</span>
            </div>
            <div class="text-gray">{{ hackathon.event_date or 'TBD' }}</div>
        </div>

        <!-- Prize Pool -->
        {% if hackathon.prize_pool and hackathon.prize_pool != 'Not specified' %}
        <div class="p-3 border rounded-2 bg-yellow-light">
            <div class="d-flex flex-items-center mb-2">
                <i class="fas fa-trophy text-yellow mr-2"></i>
                <span class="text-bold">Prize Pool</span>
            </div>
            <div class="text-bold text-yellow">{{ hackathon.prize_pool }}</div>
        </div>
        {% endif %}
    </div>

    <!-- Description -->
    {% if hackathon.description %}
    <div class="mb-4">
        <h3 class="mb-3">
            <i class="fas fa-info-circle mr-2"></i>Description
        </h3>
        <div class="p-3 bg-gray-light border rounded-2">
            <p style="white-space: pre-wrap; line-height: 1.6;">{{ hackathon.description }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Tags -->
    {% if hackathon.tags %}
    <div class="mb-4">
        <h3 class="mb-3">
            <i class="fas fa-tags mr-2"></i>Categories
        </h3>
        <div class="d-flex flex-wrap gap-2">
            {% for tag in hackathon.tags %}
            <span class="tag">{{ tag }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Eligibility -->
    {% if hackathon.eligibility %}
    <div class="mb-4">
        <h3 class="mb-3">
            <i class="fas fa-users mr-2"></i>Eligibility
        </h3>
        <div class="p-3 bg-blue-light border border-blue rounded-2">
            <span class="text-blue text-bold">{{ hackathon.eligibility }}</span>
        </div>
    </div>
    {% endif %}

    <!-- Links and Actions -->
    <div class="border-top pt-4">
        <h3 class="mb-3">
            <i class="fas fa-link mr-2"></i>Links & Actions
        </h3>
        <div class="d-flex flex-wrap gap-3">
            {% if hackathon.website_url %}
            <a href="{{ hackathon.website_url }}" target="_blank" class="btn btn-primary">
                <i class="fas fa-external-link-alt mr-1"></i>Official Website
            </a>
            {% endif %}

            <button onclick="shareHackathon()" class="btn btn-secondary">
                <i class="fas fa-share mr-1"></i>Share
            </button>

            <button onclick="exportToCalendar()" class="btn btn-secondary">
                <i class="fas fa-calendar-plus mr-1"></i>Add to Calendar
            </button>
        </div>
    </div>

    <!-- Metadata -->
    <div class="border-top pt-4 mt-4">
        <h4 class="mb-3 text-gray">Metadata</h4>
        <div class="d-grid gap-2" style="grid-template-columns: auto 1fr;">
            {% if hackathon.scraped_at %}
            <span class="text-gray">Scraped:</span>
            <span class="text-small" data-timestamp="{{ hackathon.scraped_at }}">{{ hackathon.scraped_at }}</span>
            {% endif %}

            {% if hackathon.updated_at %}
            <span class="text-gray">Updated:</span>
            <span class="text-small" data-timestamp="{{ hackathon.updated_at }}">{{ hackathon.updated_at }}</span>
            {% endif %}

            {% if hackathon.source %}
            <span class="text-gray">Source:</span>
            <span class="text-small">{{ hackathon.source }}</span>
            {% endif %}
        </div>
    </div>
</div>

<!-- Similar Hackathons -->
<div class="mt-4">
    <h3 class="mb-3">
        <i class="fas fa-lightbulb mr-2"></i>Related Actions
    </h3>
    <div class="d-flex flex-wrap gap-3">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="fas fa-search mr-1"></i>Find More Hackathons
        </a>
        <button onclick="searchSimilar()" class="btn btn-secondary">
            <i class="fas fa-sync mr-1"></i>Search Similar
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function deleteHackathon(hackathonId) {
        if (!confirm('Are you sure you want to delete this hackathon? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/delete/${hackathonId}`, {
                method: 'POST'
            });

            const result = await response.json();

            if (result.success) {
                alert('Hackathon deleted successfully!');
                window.location.href = '{{ url_for("index") }}';
            } else {
                alert('Error deleting hackathon: ' + result.error);
            }
        } catch (error) {
            alert('Network error: ' + error.message);
        }
    }

    function shareHackathon() {
        const title = '{{ hackathon.title }}';
        const url = window.location.href;
        const text = `Check out this hackathon: ${title}`;

        if (navigator.share) {
            navigator.share({
                title: title,
                text: text,
                url: url
            });
        } else {
            // Fallback to clipboard
            navigator.clipboard.writeText(`${text} - ${url}`).then(() => {
                alert('Link copied to clipboard!');
            }).catch(() => {
                prompt('Copy this link:', url);
            });
        }
    }

    function exportToCalendar() {
        const title = '{{ hackathon.title }}';
        const startDate = '{{ hackathon.event_date }}';
        const description = '{{ hackathon.description|replace("\n", "\\n")|replace("\"", "\\\"")|truncate(200) }}';
        const website = '{{ hackathon.website_url }}';

        if (startDate && startDate !== 'TBD') {
            const date = new Date(startDate);
            const dateStr = date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

            const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${dateStr}/${dateStr}&details=${encodeURIComponent(description + '\n\n' + website)}&location=${encodeURIComponent(website)}`;

            window.open(calendarUrl, '_blank');
        } else {
            alert('Event date is not specified');
        }
    }

    function searchSimilar() {
        {% if hackathon.tags %}
        const tags = {{ hackathon.tags| tojson
    }};
    const query = tags.slice(0, 3).join(' ') + ' hackathons 2024 2025';
    {% else %}
    const query = '{{ hackathon.title }} similar hackathons 2024 2025';
    {% endif %}

    // Redirect to home with search
    window.location.href = `{{ url_for('index') }}?search=${encodeURIComponent(query)}`;
}

    // Auto-populate search on home page if coming from search similar
    window.addEventListener('load', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const searchQuery = urlParams.get('search');
        if (searchQuery) {
            const searchInput = document.getElementById('search-query');
            if (searchInput) {
                searchInput.value = searchQuery;
            }
        }
    });
</script>
{% endblock %}